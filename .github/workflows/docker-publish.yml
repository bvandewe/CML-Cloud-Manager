name: Build and Publish Docker Image

on:
    push:
        tags: ['v*.*.*']
    pull_request:
        branches: [main]
    workflow_dispatch: {}

permissions:
    contents: read
    packages: write
    id-token: write

env:
    IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/lablet-cloud-manager
    DOCKERFILE_PATH: Dockerfile
    CONTEXT: .

jobs:
    build-and-push:
        name: Build & Push
        runs-on: ubuntu-latest
        timeout-minutes: 30
        outputs:
            version: ${{ steps.version.outputs.version }}
        concurrency:
            group: docker-publish-${{ github.ref }}
            cancel-in-progress: true
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Extract Version
              id: version
              run: |
                  if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
                    VERSION="${GITHUB_REF_NAME}"
                  else
                    VERSION=$(grep -m1 '^version =' pyproject.toml | sed -E 's/version = "(.*)"/\1/')
                    if [[ -z "$VERSION" ]]; then VERSION="sha-${GITHUB_SHA::7}"; fi
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Set up QEMU (multi-arch)
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.repository_owner }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Prepare Tags
              id: tags
              run: |
                  VERSION='${{ steps.version.outputs.version }}'
                  IMAGE='${{ env.IMAGE_NAME }}'
                  TAGS="${IMAGE}:${VERSION}"
                  # For semver tags v1.2.3 also push major & major.minor
                  if [[ "$VERSION" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    V=${VERSION#v}
                    MAJOR=$(echo $V | cut -d. -f1)
                    MINOR=$(echo $V | cut -d. -f2)
                    TAGS="${TAGS}\n${IMAGE}:${MAJOR}\n${IMAGE}:${MAJOR}.${MINOR}\n${IMAGE}:latest"
                  elif [[ "$GITHUB_REF_TYPE" != "tag" ]]; then
                    TAGS="${TAGS}\n${IMAGE}:dev"
                  fi
                  # Output as multi-line format for docker/build-push-action
                  echo "tags<<EOF" >> $GITHUB_OUTPUT
                  echo -e "$TAGS" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Build Image (PR / branch)
              if: github.event_name != 'push' || github.ref != 'refs/heads/main'
              uses: docker/build-push-action@v5
              with:
                  context: ${{ env.CONTEXT }}
                  file: ${{ env.DOCKERFILE_PATH }}
                  push: false
                  platforms: linux/amd64
                  build-args: |
                      BUILD_VERSION=${{ steps.version.outputs.version }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Build & Push Image (main/tag)
              if: github.event_name == 'push'
              uses: docker/build-push-action@v5
              with:
                  context: ${{ env.CONTEXT }}
                  file: ${{ env.DOCKERFILE_PATH }}
                  push: true
                  platforms: linux/amd64
                  build-args: |
                      BUILD_VERSION=${{ steps.version.outputs.version }}
                  tags: ${{ steps.tags.outputs.tags }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Summarize
              run: |
                  echo "Built version: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
                  echo "Image tags: ${{ steps.tags.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

    trivy-scan:
        name: Vulnerability Scan
        runs-on: ubuntu-latest
        needs: build-and-push
        if: github.event_name == 'push'
        steps:
            - name: Pull image
              run: docker pull ${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version || 'latest' }} || docker pull ${{ env.IMAGE_NAME }}:latest
            - name: Run Trivy scan
              uses: aquasecurity/trivy-action@0.14.0
              with:
                  image-ref: ${{ env.IMAGE_NAME }}:latest
                  format: table
                  exit-code: 0
                  ignore-unfixed: true
                  severity: HIGH,CRITICAL
