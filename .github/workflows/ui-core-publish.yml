name: UI Core - Publish to GitHub Packages

on:
    push:
        tags:
            - 'ui-core-v*.*.*'
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to publish (e.g., 0.1.0)'
                required: true
                type: string
            dry_run:
                description: 'Dry run (do not publish)'
                required: false
                type: boolean
                default: false

permissions:
    contents: read
    packages: write

defaults:
    run:
        working-directory: src/core/lcm_ui

env:
    NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    publish:
        name: Build & Publish
        runs-on: ubuntu-latest
        timeout-minutes: 15

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  registry-url: 'https://npm.pkg.github.com'
                  scope: '@neuroglia'
                  cache: 'npm'
                  cache-dependency-path: src/core/lcm_ui/package-lock.json

            - name: Extract version from tag
              id: version
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    # Extract version from tag: ui-core-v1.2.3 -> 1.2.3
                    VERSION="${GITHUB_REF_NAME#ui-core-v}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Publishing version: $VERSION"

            - name: Update package.json version
              run: |
                  npm version ${{ steps.version.outputs.version }} --no-git-tag-version --allow-same-version

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm run test

            - name: Build package
              run: npm run build

            - name: Verify build output
              run: |
                  echo "=== Package info ==="
                  npm pack --dry-run 2>&1 | head -30
                  echo ""
                  echo "=== Bundle sizes ==="
                  du -sh dist/*.js 2>/dev/null || true
                  du -sh dist/**/*.js 2>/dev/null || true

            - name: Configure npm for GitHub Packages
              run: |
                  echo "@neuroglia:registry=https://npm.pkg.github.com" >> .npmrc
                  echo "//npm.pkg.github.com/:_authToken=\${NODE_AUTH_TOKEN}" >> .npmrc

            - name: Publish to GitHub Packages
              if: ${{ github.event.inputs.dry_run != 'true' }}
              run: npm publish --access public
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Dry run - Show what would be published
              if: ${{ github.event.inputs.dry_run == 'true' }}
              run: |
                  echo "=== DRY RUN - Package would be published ==="
                  npm pack
                  echo ""
                  echo "=== Package contents ==="
                  tar -tzf *.tgz | head -50

    notify:
        name: Create Release Summary
        runs-on: ubuntu-latest
        needs: publish
        if: success() && github.event.inputs.dry_run != 'true'

        permissions:
            contents: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Extract version
              id: version
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    VERSION="${{ github.event.inputs.version }}"
                  else
                    VERSION="${GITHUB_REF_NAME#ui-core-v}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              with:
                  name: '@neuroglia/ui-core v${{ steps.version.outputs.version }}'
                  body: |
                      ## @neuroglia/ui-core v${{ steps.version.outputs.version }}

                      Published to GitHub Packages.

                      ### Installation

                      ```bash
                      # Configure npm for GitHub Packages
                      echo "@neuroglia:registry=https://npm.pkg.github.com" >> .npmrc

                      # Install
                      npm install @neuroglia/ui-core@${{ steps.version.outputs.version }}
                      ```

                      ### What's included

                      - EventBus: Pub/sub event system with wildcards and middleware
                      - StateStore: Centralized state management with slices
                      - SSEClient: Server-Sent Events client with auto-reconnect
                      - SessionManager: Authentication session management
                      - Web Components: BaseComponent, StatusBadge, MetricCard, TabView, Modal, ActionBar, DataTable
                      - Middleware: Logger, devtools, throttle, persist
                  draft: false
                  prerelease: ${{ contains(steps.version.outputs.version, '-') }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
