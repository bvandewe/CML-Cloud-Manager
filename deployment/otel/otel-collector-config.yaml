receivers:
    otlp:
        protocols:
            grpc:
                endpoint: 0.0.0.0:4317
            http:
                endpoint: 0.0.0.0:4318

    # Host metrics receiver
    hostmetrics:
        root_path: /hostfs
        collection_interval: 10s
        scrapers:
            cpu:
            memory:
            load:
            disk:
            filesystem:
            network:

    # Docker stats receiver
    docker_stats:
        endpoint: unix:///var/run/docker.sock
        collection_interval: 10s
        timeout: 20s
        api_version: '1.44'

    # Redis receiver
    redis:
        endpoint: 'redis:6379'
        collection_interval: 10s

    # MongoDB receiver
    mongodb:
        hosts:
            - endpoint: 'mongodb:27017'
        collection_interval: 10s
        username: ${env:MONGODB_USERNAME}
        password: ${env:MONGODB_PASSWORD}
        tls:
            insecure: true
        metrics:
            mongodb.index.access.count:
                enabled: false
            mongodb.index.count:
                enabled: false
            mongodb.index.size:
                enabled: false
            mongodb.collection.count:
                enabled: false
            mongodb.collection.size:
                enabled: false
            mongodb.extent.count:
                enabled: false
            mongodb.object.count:
                enabled: false
            mongodb.object.size:
                enabled: false
            mongodb.storage.size:
                enabled: false

extensions:
    health_check:
        endpoint: 0.0.0.0:13133

processors:
    batch:
        timeout: 10s
        send_batch_size: 1024
    memory_limiter:
        check_interval: 1s
        limit_mib: 512
    # Add resource attributes to distinguish metrics
    resource:
        attributes:
            - key: service.name
              value: 'cml-cloud-manager-host'
              action: insert
    # Filter out system metrics from application to avoid conflicts with hostmetrics
    filter/drop_system_metrics:
        metrics:
            exclude:
                match_type: regexp
                metric_names:
                    - ^system[._].*
                    - ^process[._].*

exporters:
    logging:
        loglevel: info
    prometheus:
        endpoint: '0.0.0.0:8889'
        namespace: cml_cloud_manager
        const_labels:
            environment: production
    otlp/tempo:
        endpoint: tempo:4317
        tls:
            insecure: true
    loki:
        endpoint: http://loki:3100/loki/api/v1/push

service:
    extensions: [health_check]
    pipelines:
        traces:
            receivers: [otlp]
            processors: [memory_limiter, batch]
            exporters: [logging, otlp/tempo]
        metrics/app:
            receivers: [otlp]
            processors: [filter/drop_system_metrics, memory_limiter, batch, resource]
            exporters: [logging, prometheus]
        metrics/infra:
            receivers: [hostmetrics, docker_stats, redis, mongodb]
            processors: [memory_limiter, batch, resource]
            exporters: [logging, prometheus]
        logs:
            receivers: [otlp]
            processors: [memory_limiter, batch]
            exporters: [logging, loki]
